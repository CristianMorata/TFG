<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <title>Panel de Gesti√≥n</title>
  <style>
    body {
      font-family: Arial;
      padding: 20px;
    }

    section {
      margin-bottom: 40px;
      border-bottom: 1px solid #ccc;
      padding-bottom: 20px;
    }

    input,
    select,
    textarea {
      display: block;
      margin: 5px 0 15px;
      padding: 5px;
      width: 100%;
      max-width: 400px;
    }

    button {
      margin-top: 10px;
      padding: 8px 16px;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 10px;
    }

    th,
    td {
      border: 1px solid #ccc;
      padding: 6px;
      text-align: left;
    }

    th {
      background-color: #eee;
    }

    h2 {
      margin-top: 0;
    }
  </style>
</head>

<body>
  <h1>Panel de Pruebas</h1>

  <!-- Agregar Producto de Venta -->
  <section>
    <h2>Agregar Producto de Venta</h2>
    <form id="formProducto">
      <input name="nombre" placeholder="Nombre" required />
      <input name="descripcion" placeholder="Descripci√≥n" required />
      <input name="precio" type="number" step="0.01" placeholder="Precio" required />
      <input name="tipo_producto" placeholder="Tipo de producto" required />
      <input name="alergenos" placeholder="Alergenos (coma separados)" />
      <input name="intolerancias" placeholder="Intolerancias (coma separados)" />
      <input name="anadido_por" placeholder="A√±adido por" />
      <input name="fecha_anadido" placeholder="Fecha a√±adido (opcional)" />
      <input name="anotaciones" placeholder="Anotaciones" />
      <label><input type="checkbox" name="visible" /> Visible</label>
      <label><input type="checkbox" name="es_nuevo" /> Es nuevo</label>
      <button type="submit">Agregar</button>
    </form>
    <div id="resProducto"></div>
    <button onclick="listarProductos()">üìã Ver Productos</button>
    <table id="tablaProductos">
      <thead>
        <tr>
          <th>ID</th>
          <th>Nombre</th>
          <th>Precio</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <!-- Modificar Producto de Venta -->
  <section>
    <h2>Modificar Producto de Venta</h2>
    <form id="formEditarProducto">
      <input name="id" placeholder="ID del producto a modificar" required />
      <input name="nombre" placeholder="Nombre (opcional)" />
      <input name="descripcion" placeholder="Descripci√≥n (opcional)" />
      <input name="precio" type="number" step="0.01" placeholder="Precio (opcional)" />
      <input name="tipo_producto" placeholder="Tipo de producto (opcional)" />
      <input name="alergenos" placeholder="Alergenos (coma separados)" />
      <input name="intolerancias" placeholder="Intolerancias (coma separados)" />
      <input name="anadido_por" placeholder="A√±adido por" />
      <input name="fecha_anadido" placeholder="Fecha a√±adido (opcional)" />
      <input name="anotaciones" placeholder="Anotaciones" />
      <label><input type="checkbox" name="visible" /> Visible</label>
      <label><input type="checkbox" name="es_nuevo" /> Es nuevo</label>
      <button type="submit">Modificar</button>
    </form>
    <div id="resEditarProducto"></div>
  </section>

  <!-- Agregar Pedido a Proveedor -->
  <section>
    <h2>Agregar Pedido a Proveedor</h2>
    <form id="formPedido">
      <input name="proveedor" placeholder="Proveedor" />
      <input name="presupuesto" type="number" step="0.01" placeholder="Presupuesto" />
      <input name="fecha_entrega" placeholder="Fecha entrega" />
      <input name="tipo" placeholder="Tipo" />
      <input name="alergenos" placeholder="Alergenos (coma separados)" />
      <input name="intolerancias" placeholder="Intolerancias (coma separados)" />
      <button type="submit">Agregar</button>
    </form>
    <div id="resPedido"></div>
  </section>

  <!-- Agregar Empleado -->
  <section>
    <h2>Agregar Empleado</h2>
    <form id="formEmpleado">
      <input name="nombre" placeholder="Nombre" />
      <input name="apellidos" placeholder="Apellidos" />
      <input name="fecha_nacimiento" placeholder="Fecha nacimiento" />
      <input name="telefono" placeholder="Tel√©fono" />
      <input name="email" placeholder="Email" />
      <input name="puesto" placeholder="Puesto" />
      <input name="fecha_contratacion" placeholder="Fecha contrataci√≥n" />
      <input name="tipo_jornada" placeholder="Tipo de jornada" />
      <input name="salario" type="number" placeholder="Salario" />
      <input name="estado" placeholder="Estado" />
      <input name="horario" placeholder="Horario" />
      <input name="idiomas" placeholder="Idiomas (coma separados)" />
      <textarea name="observaciones" placeholder="Observaciones"></textarea>
      <button type="submit">Agregar</button>
    </form>
    <div id="resEmpleado"></div>
    <button onclick="listarEmpleados()">üìã Ver Empleados</button>
    <table id="tablaEmpleados">
      <thead>
        <tr>
          <th>ID</th>
          <th>Nombre</th>
          <th>Puesto</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <!-- Crear o Modificar Mesa -->
  <section>
    <h2>Crear / Modificar Mesa</h2>
    <form id="formMesa">
      <input name="mesaId" placeholder="ID de la mesa (ej. mesa_1)" required />
      <textarea name="contenido" placeholder='Contenido (array de productos en JSON)' rows="3"></textarea>
      <input name="estado" placeholder="Estado (libre, ocupada...)" />
      <textarea name="anotaciones" placeholder="Anotaciones" rows="2"></textarea>
      <button type="submit">Guardar / Modificar</button>
    </form>
    <div id="resMesa"></div>
  </section>

  <!-- Cerrar Mesa -->
  <section>
    <h2>Cerrar Mesa</h2>
    <form id="formCerrarMesa">
      <input name="mesaId" placeholder="ID de la mesa a cerrar" required />
      <button type="submit">Cerrar y Archivar</button>
    </form>
    <div id="resCerrarMesa"></div>
  </section>

  <script>
    const endpoints = {
      agregarProductoVenta: "https://agregarproductoventa-rs2gjhs4iq-uc.a.run.app",
      listarProductosVenta: "https://listarproductosventa-rs2gjhs4iq-uc.a.run.app",
      agregarPedidoProveedor: "https://agregarpedidoproveedor-rs2gjhs4iq-uc.a.run.app",
      agregarEmpleado: "https://agregarempleado-rs2gjhs4iq-uc.a.run.app",
      listarEmpleados: "https://listarempleados-rs2gjhs4iq-uc.a.run.app",
      guardarOModificarMesa: "https://guardaromodificarmesa-rs2gjhs4iq-uc.a.run.app",
      cerrarMesa: "https://cerrarmesa-rs2gjhs4iq-uc.a.run.app",
      modificarProductoVenta: "https://modificarproductoventa-rz8pjh4iq-uc.a.run.app",
    };

    async function enviarFormulario(formId, url, salidaId, extraParser = data => data) {
      const form = document.getElementById(formId);
      const salida = document.getElementById(salidaId);
      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        const data = Object.fromEntries(new FormData(form));
        // Conversi√≥n especial de campos JSON o arrays
        if (data.alergenos) data.alergenos = data.alergenos.split(",").map(x => x.trim());
        if (data.intolerancias) data.intolerancias = data.intolerancias.split(",").map(x => x.trim());
        if (data.idiomas) data.idiomas = data.idiomas.split(",").map(x => x.trim());
        if (data.precio) data.precio = parseFloat(data.precio);
        if (data.salario) data.salario = parseFloat(data.salario);
        if (data.presupuesto) data.presupuesto = parseFloat(data.presupuesto);
        if (data.visible) data.visible = true;
        if (data.es_nuevo) data.es_nuevo = true;
        if (data.contenido) {
          try {
            data.contenido = JSON.parse(data.contenido);
          } catch (e) {
            salida.textContent = "‚ö†Ô∏è Error: contenido no es JSON v√°lido";
            return;
          }
        }

        try {
          const res = await fetch(url, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(extraParser(data))
          });
          const json = await res.json();
          salida.textContent = res.ok ? `‚úÖ ${json.mensaje || '√âxito'}` : `‚ùå ${JSON.stringify(json)}`;
        } catch (err) {
          salida.textContent = "‚ùå Error en la solicitud";
        }
      });
    }

    // Asignar formularios
    enviarFormulario("formProducto", endpoints.agregarProductoVenta, "resProducto");
    enviarFormulario("formPedido", endpoints.agregarPedidoProveedor, "resPedido");
    enviarFormulario("formEmpleado", endpoints.agregarEmpleado, "resEmpleado");
    enviarFormulario("formMesa", endpoints.guardarOModificarMesa, "resMesa");
    enviarFormulario("formCerrarMesa", endpoints.cerrarMesa, "resCerrarMesa");
    enviarFormulario("formEditarProducto", endpoints.modificarProductoVenta, "resEditarProducto");

    // Listado de productos
    async function listarProductos() {
      const tabla = document.querySelector("#tablaProductos tbody");
      tabla.innerHTML = "";
      try {
        const res = await fetch(endpoints.listarProductosVenta);
        const datos = await res.json();
        datos.forEach(p => {
          tabla.innerHTML += `<tr><td>${p.id}</td><td>${p.nombre}</td><td>${p.precio || ""}</td></tr>`;
        });
      } catch {
        tabla.innerHTML = "<tr><td colspan='3'>‚ùå Error</td></tr>";
      }
    }

    // Listado de empleados
    async function listarEmpleados() {
      const tabla = document.querySelector("#tablaEmpleados tbody");
      tabla.innerHTML = "";
      try {
        const res = await fetch(endpoints.listarEmpleados);
        const datos = await res.json();
        datos.forEach(e => {
          tabla.innerHTML += `<tr><td>${e.id}</td><td>${e.nombre} ${e.apellidos}</td><td>${e.puesto || ""}</td></tr>`;
        });
      } catch {
        tabla.innerHTML = "<tr><td colspan='3'>‚ùå Error</td></tr>";
      }
    }
  </script>
</body>

</html>